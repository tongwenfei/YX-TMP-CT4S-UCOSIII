#include "timer.h"

//基本定时器6中断初始化
//这里时钟选择为APB1的2倍，而APB1为36M
//arr：自动重装值。
//psc：时钟预分频数
//这里使用的是定时器6!
uint32_t Definite_Count[4]={0};
bool isPause=false;
uint16_t cnt_buf=0;
void TIM6_Int_Init(u16 arr,u16 psc)
{
  TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
  NVIC_InitTypeDef NVIC_InitStructure;
  RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM6,ENABLE); //定时器6时钟使能
  
  TIM_TimeBaseInitStructure.TIM_Prescaler=psc;  //设置分频值，10khz的计数频率
  TIM_TimeBaseInitStructure.TIM_CounterMode=TIM_CounterMode_Up; //向上计数模式
  TIM_TimeBaseInitStructure.TIM_Period=arr;  //自动重装载值 计数到5000为500ms
  TIM_TimeBaseInitStructure.TIM_ClockDivision=0; //时钟分割:TDS=Tck_Tim
  TIM_TimeBaseInit(TIM6,&TIM_TimeBaseInitStructure);
  
  TIM_ITConfig(TIM6,TIM_IT_Update|TIM_IT_Trigger,ENABLE); //使能TIM6的更新中断
  
  NVIC_InitStructure.NVIC_IRQChannel=TIM6_IRQn; //TIM6中断
  NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=1; //先占优先级1级
  NVIC_InitStructure.NVIC_IRQChannelSubPriority=3;  //从优先级3级
  NVIC_InitStructure.NVIC_IRQChannelCmd=ENABLE; //使能通道
  NVIC_Init(&NVIC_InitStructure);
  
  TIM_Cmd(TIM6,DISABLE); //定时器6使能
  isPause=true;
  cnt_buf=0;
}


void TIM6_IRQHandler(void)
{
  if(TIM_GetITStatus(TIM6,TIM_IT_Update)!=RESET)
  {
    if(Sampling_State[0]==Runing)
    {
      Definite_Count[0]++;
    }
    if(Sampling_State[1]==Runing)
    {
      Definite_Count[1]++;
    }
    if(Sampling_State[2]==Runing)
    {
      Definite_Count[2]++;
    }
    if(Sampling_State[3]==Runing)
    {
      Definite_Count[3]++;
    }
    
  }
  TIM_ClearITPendingBit(TIM6,TIM_IT_Update); //清除中断标志位
}
void TIM6_Start(void)
{
  if(!((TIM6->CR1)&TIM_CR1_CEN))
  {
    if(isPause)
    {
      TIM_Cmd(TIM6,ENABLE); //定时器6使能
      TIM_SetCounter(TIM6,cnt_buf);
      isPause=false;
    }
    else
    {
      TIM_Cmd(TIM6,ENABLE); //定时器6使能
      TIM_SetCounter(TIM6,0);
      isPause=false;
    }
  }
  
}
void TIM6_Pause(void)
{
  if(((TIM6->CR1)&TIM_CR1_CEN))
  {
    TIM_Cmd(TIM6,DISABLE); //定时器6使能
    cnt_buf=TIM_GetCounter(TIM6);
    isPause=true;
  }
  
}
void TIM6_Stop(void)
{
  if(((TIM6->CR1)&TIM_CR1_CEN))
  {
    TIM_Cmd(TIM6,DISABLE); //定时器6使能
    TIM_SetCounter(TIM6,0);
    cnt_buf=0;
  }
}

void Start_Sampling(void)
{
  

}

void Pause_Sampling(void)
{
  
}
void Stop_Sampling(void)
{
  
}